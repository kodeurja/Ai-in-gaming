{% extends "layout.html" %}
{% block content %}
<div class="quiz-wrapper">
    <div class="cyber-terminal">
        <div class="terminal-header">
            <div class="terminal-title">>> GAUNTLET_PROTOCOL_V4.2 // GATE_ACCESS</div>
            <div class="terminal-dots">
                <span></span><span></span><span></span>
            </div>
        </div>

        <div class="terminal-body">
            <div class="hud-progress">
                <span id="progress-text">UPLOADING CONSCIOUSNESS... 0%</span>
                <span id="q-tracker">Q: 1/5</span>
            </div>

            <div id="quiz-ui">
                <div class="question-card" id="question-text">
                    Initializing Neural Link...
                </div>

                <div class="options-grid" id="options-container">
                    <!-- Options injected here -->
                </div>
            </div>

            <div id="status-message" style="margin-top: 20px; color: var(--text-muted); min-height: 24px;"></div>
        </div>
    </div>
</div>

<!-- Custom Access Modal -->
<div class="custom-modal-overlay" id="modal-overlay">
    <div class="custom-modal">
        <div class="modal-icon" id="modal-icon">ðŸ”’</div>
        <div class="modal-title" id="modal-title">ACCESS GRANTED</div>
        <div class="modal-message" id="modal-message">>> GATE UNLOCKED. PROCEED TO NODE.</div>
        <button class="modal-btn" id="modal-btn">ACKNOWLEDGE</button>
    </div>
</div>

<script>
    const quizData = {{ quiz.questions | tojson }};
    const quizId = {{ quiz.id }};
    let currentIdx = 0;
    let answers = [];

    function showCustomModal(title, message, isSuccess, callback) {
        const overlay = document.getElementById('modal-overlay');
        const titleEl = document.getElementById('modal-title');
        const msgEl = document.getElementById('modal-message');
        const iconEl = document.getElementById('modal-icon');
        const btn = document.getElementById('modal-btn');

        titleEl.innerText = title;
        msgEl.innerText = message;
        iconEl.innerText = isSuccess ? 'ðŸ”“' : 'ðŸ”’';
        overlay.style.display = 'flex';
        setTimeout(() => overlay.classList.add('active'), 10);

        btn.onclick = () => {
            overlay.classList.remove('active');
            setTimeout(() => {
                overlay.style.display = 'none';
                if (callback) callback();
            }, 300);
        };
    }

    function renderQuestion() {
        if (currentIdx >= quizData.length) {
            submitQuiz();
            return;
        }

        const q = quizData[currentIdx];

        // Update HUD
        document.getElementById('q-tracker').innerText = `Q: ${currentIdx + 1}/${quizData.length}`;
        document.getElementById('progress-text').innerText = `SYNC RATE: ${Math.round((currentIdx / quizData.length) * 100)}%`;

        // Update Text
        const qText = document.getElementById('question-text');
        qText.style.opacity = 0;
        setTimeout(() => {
            qText.innerHTML = q.question;
            qText.style.opacity = 1;
        }, 200);

        // Render Options
        const optsDiv = document.getElementById('options-container');
        optsDiv.innerHTML = '';

        q.options.forEach((opt, idx) => {
            const btn = document.createElement('div');
            btn.className = 'option-btn';
            btn.innerText = `> ${opt}`;
            btn.onclick = () => selectOption(idx, btn);
            optsDiv.appendChild(btn);
        });
    }

    function selectOption(idx, btn) {
        // Disable all
        document.querySelectorAll('.option-btn').forEach(b => {
            b.style.pointerEvents = 'none';
        });

        const q = quizData[currentIdx];
        // Use 'correct_index' as per AI Engine spec
        const correctIdx = q.correct_index !== undefined ? q.correct_index : q.answer;

        const isCorrect = (idx === correctIdx);

        if (isCorrect) {
            btn.classList.add('correct');
            btn.innerHTML += ' [VERIFIED]';
            document.getElementById('status-message').innerText = ">> ANSWER CORRECT. UPLOADING...";
            document.getElementById('status-message').style.color = "var(--success)";
        } else {
            btn.classList.add('wrong');
            btn.innerHTML += ' [ERROR]';
            // Show correct
            const allBtns = document.querySelectorAll('.option-btn');
            if (allBtns[correctIdx]) {
                allBtns[correctIdx].classList.add('correct');
            }
            document.getElementById('status-message').innerText = ">> CRITICAL FAILURE. SEQUENCE ABORTED.";
            document.getElementById('status-message').style.color = "var(--danger)";
        }

        answers.push(idx);

        setTimeout(() => {
            // Always proceed
            currentIdx++;
            renderQuestion();
        }, 1500);
    }

    function submitQuiz() {
        document.getElementById('question-text').innerText = ">> FINALIZING SEQUENCE...";
        document.getElementById('options-container').innerHTML = '<div class="pulsar-effect" style="color:var(--primary); text-align:center;">CALCULATING NEURAL CHECKSUM...</div>';

        fetch('/api/submit_quiz', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ quiz_id: quizId, answers: answers })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.passed) {
                    document.getElementById('progress-text').innerText = "SYNC RATE: 100%";
                    showCustomModal("ACCESS GRANTED", ">> GATE UNLOCKED. PROCEED TO NODE.", true, () => {
                        if (data.redirect) {
                            window.location.href = data.redirect;
                        } else {
                            window.location.href = "/puzzle/{{ state.current_step }}";
                        }
                    });
                } else {
                    showCustomModal("VERIFICATION FAILED", ">> CRITICAL ERROR: ACCESS DENIED. RETRYING SEQUENCE.", false, () => {
                        window.location.href = "{{ url_for('quiz_setup') }}";
                    });
                }
            })
            .catch(err => {
                console.error(err);
                showCustomModal("SYSTEM ERROR", ">> NEURAL LINK DISCONNECTED: " + err, false);
            });
    }

    // Start
    renderQuestion();
</script>
{% endblock %}