{% extends "layout.html" %}
{% block content %}
<div class="puzzle-gate-overlay" id="puzzle-screen">
    <div class="puzzle-header">
        <div class="puzzle-info">
            <span class="tag">GATEWAY NODE {{ puzzle_data.step }}</span>
            <h1 id="puzzle-title" class="glitch-text">{{ puzzle_data.title }}</h1>
            <p id="puzzle-desc">{{ puzzle_data.description }}</p>
        </div>
        <div class="puzzle-controls">
            <button class="btn-retry" onclick="resetPuzzle()">REBOOT</button>
        </div>
    </div>

    <div class="puzzle-stage">
        <div id="puzzle-canvas-container" class="puzzle-canvas-container">
            <!-- Puzzle elements injected via JS -->
        </div>
    </div>

    <!-- Celebration / Success Modal -->
    <div id="puzzle-success-modal" class="puzzle-modal" style="display:none;">
        <div class="modal-content glass celebration">
            <div class="confetti-container"></div>
            <h2 class="animate-reveal">NODE SYNCHRONIZED</h2>
            <p class="animate-reveal" style="animation-delay: 0.2s;">Gateway stability 100%. Initializing hyper-jump
                sequence...</p>
            <button class="btn-primary animate-reveal pulsar-effect" style="animation-delay: 0.4s;"
                onclick="finishPuzzle()">ENGAGE WARP</button>
        </div>
    </div>
</div>

<link rel="stylesheet" href="{{ url_for('static', filename='css/puzzle_styles.css') }}">
<script src="{{ url_for('static', filename='js/puzzles.js') }}?v={{ range(1, 10000) | random }}"></script>
<script>
    const puzzleStep = {{ step }};
    const puzzleType = "{{ puzzle_type }}";
    const puzzleData = {{ puzzle_data| tojson }};

    window.onerror = function (msg, url, line, col, error) {
        const errBox = document.getElementById('err-dashboard') || createErrBox();
        errBox.innerHTML += `<div style="border-bottom:1px solid #fff; padding:5px;">${msg} <br> ${url}:${line}:${col}</div>`;
        errBox.style.display = 'block';
        return false;
    };

    function createErrBox() {
        const div = document.createElement('div');
        div.id = 'err-dashboard';
        div.style.cssText = "position:fixed; bottom:10px; right:10px; background:rgba(255,0,0,0.8); color:white; width:400px; max-height:300px; overflow:auto; z-index:9999; padding:10px; font-family:monospace; font-size:12px; display:none;";
        document.body.appendChild(div);
        return div;
    }

    window.onload = () => {
        try {
            console.log("Loading PuzzleManager...");
            if (typeof PuzzleManager === 'undefined') {
                throw new Error("PuzzleManager is undefined! Logic File not loaded.");
            }
            // We pass puzzleData to the init so it can use AI parameters
            PuzzleManager.init(puzzleType, puzzleStep, puzzleData);
        } catch (e) {
            console.error(e);
            window.onerror(e.message, "onload", 0, 0, e);
        }
    };

    function finishPuzzle() {
        fetch('/api/solve_puzzle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ step: puzzleStep })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    window.location.href = data.next_url;
                }
            })
            .catch(err => console.error(err));
    }

    function getPuzzleHint() {
        const btn = document.querySelector('.btn-hint');
        btn.innerText = "THINKING...";
        btn.disabled = true;

        fetch('/api/puzzle_hint', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ step: puzzleStep, puzzle_type: puzzleType })
        })
            .then(res => res.json())
            .then(data => {
                alert("AI HINT: " + data.hint);
                btn.innerText = "AI HINT";
                btn.disabled = false;
            });
    }

    function resetPuzzle() {
        if (confirm("REBOOT SYSTEM? This will regenerate a new animal puzzle.")) {
            fetch('/api/reboot_puzzle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ step: puzzleStep })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    }
                });
        }
    }
</script>

<style>
    .celebration {
        animation: celebration-pop 0.6s cubic-bezier(0.17, 0.67, 0.83, 0.67);
        border: 2px solid var(--success) !important;
        box-shadow: 0 0 50px var(--success) !important;
    }

    @keyframes celebration-pop {
        0% {
            transform: scale(0.8) translate(-50%, -50%);
            opacity: 0;
        }

        100% {
            transform: scale(1) translate(-50%, -50%);
            opacity: 1;
        }
    }

    .animate-reveal {
        opacity: 0;
        animation: reveal 0.5s forwards;
    }

    @keyframes reveal {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .puzzle-header {
        padding: 20px 50px;
        background: rgba(0, 0, 0, 0.5);
        border-bottom: 1px solid var(--border);
    }
</style>
{% endblock %}